# 文本整理

- 拿一张图片，尺寸是 \( H \times W \times 3 \)，就是普通的RGB图像，先丢进SAM这个大模型。SAM是预训练好的，参数冻住了，专门用来提特征。给它加个 \( 8 \times 8 \) 的点网格当提示，让它找物体的边界。SAM一处理，吐出来三组特征：深层图像嵌入 \( E_i \)，带着全局信息；浅层特征 \( E_s \)，有点局部细节；还有掩码嵌入 \( E_m \)，是SAM对边界的初步猜想。

- 这三组特征格式不太一样，得整整齐。用卷积层 \( W_i^t \) 把 \( E_i \) 变成 \( E_i^e \)，\( W_s^t \) 把 \( E_s \) 变成 \( E_s^e \)，再用 \( W_m^t \) 和重塑操作把 \( E_m \) 变成 \( E_m^e \)。现在 \( E_i^e \) 和 \( Convert_s^e \) 都是 \( D \times D \times C_1 \)，\( E_m^e \) 是 \( D \times D \times (C_2 \times 64) \)，尺寸对齐了，可以往下走。

- 接下来进Side Transfer Network（STN）。先拿 \( E_i^e \)，用卷积层 \( W_c^h \) 处理，直接生成粗粒度特征 \( F^c \)，就像画个大轮廓，挺粗糙。接着把 \( E_i^e \) 和 \( E_s^e \) 送进第一个Feature Fusion Block（FFB1），用卷积层 \( W_c^g \) 处理粗粒度特征 \( E_c \)，跟 \( E_i^e \) 相乘增强信息，再和 \( E_s^e \) 融合，FFB1用交叉注意力和门控卷积混在一起，加点细节，出来后用 \( W_m^h \) 变成中粒度特征 \( F^m \)，这就像在轮廓上添了点细节，画出中等的边缘。

- 然后拿中粒度特征 \( E^m \) 和掩码特征 \( E_m^e \)，用卷指层 \( W_m^g \) 处理 \( F_m \) 跟 \( E^m \) 相乘，生成 \( E^f \)，再用 \( W_f^h \) 变成 \( F^f \)，最后进第二个FFB2跟 \( E_m^e \) 融合，生成细粒度特征 \( E^{f'} \)，这步加了SAM掩码的信息，特别精细，像精雕细琢，突出纹理细节。

- 有了 \( F^c, F_m, F^f \)，用共享的分类头把它们画成边缘图：\( F^c \) 变成粗粒度 \(\hat{Y}^c\)，\( F^m \) 和 \( F^c \) 拼接后用卷积层 \( W_m^s \) 处理，变成中粒度 \(\hat{Y}^m\)，\( F^f \) 和 \(\hat{F}^m \) 拼接后用 \( W_f^s \) 处理，变成细粒度 \(\hat{Y}^f\)，这些边缘图尺寸都是 \( D \times D \)。再把 \(\hat{F}^m\) 和 \(\hat{F}^f\) 融合，用卷积层和分类头生成最终输出 \(\hat{Y}^u\)，这是综合了所有粒度的完整边缘图。

- 顺便一提，SAM的物体掩码还能直接用，拿Sobel滤波器处理，提取边缘，得到一个零样本预测 \( y_{\text{mask}} \)，尺寸大概是 \( H \times W \)，这步不用训练。

- 为了让边缘图更准，用三个损失函数调优：\( L_{\text{side}} \) 让侧输出跟伪标签对齐，\( L_{\text{differ}} \) 鼓励粗、中、细有差异，\( L_{\text{guide}} \) 用SAM掩码引导最终输出更准。总损失是 \( L_{\text{guide}} + 0.1 L_{\text{differ}} + 0.5 L_{\text{side}} \)，优化整个网络。

- 最后想生成任意粒度的边缘图，用参数 \(\alpha \)（0到1）做线性加权，0最粗，1最细，公式是：\(\alpha \leq 0.5\) 时，\(\frac{\alpha}{0.5} \hat{Y}^m + (1 - \frac{\alpha}{0.5}) \hat{Y}^c\)；\(\alpha > 0.5\) 时，\(\frac{\alpha - 0.5}{0.5} \hat{Y}^f + (1 - \frac{\alpha - 0.5}{0.5}) \hat{Y}^m\)。这样就能得到任意粒度的边缘图 \(\hat{Y}^\alpha\)，尺寸还是 \( D \times D \)。

---

### 补充说明
- 上面整理的文本主要是基于之前的讲解内容，修正了部分笔误（如 \( F_m \) 应为 \( F^m \)，\( Convert_s^e \) 应为 \( E_s^e \)）。
- 如果需要进一步调整或补充其他内容，请告诉我！